<div id="app">
    <h2>Figma Todo List</h2>
    
    <div class="add-todo">
        <img 
            id="selectionPreview" 
            class="preview-image hidden" 
            alt="Selection Preview"
        >
        <div class="input-group">
            <input type="text" id="todoInput" placeholder="Enter a todo...">
            <button onclick="addTodo()">Add Todo</button>
        </div>
    </div>

    <div id="todoList"></div>
</div>

<style>
    body {
        font-family: Inter, sans-serif;
        padding: 20px;
    }
    
    .add-todo {
        display: flex;
        gap: 12px;
        margin-bottom: 16px;
        align-items: center;
    }
    
    .input-group {
        display: flex;
        gap: 8px;
        flex: 1;
    }
    
    .hidden {
        display: none;
    }
    
    #selectionPreview {
        width: 64px;
        height: 64px;
        object-fit: contain;
        background: #f0f0f0;
        border-radius: 4px;
    }
    
    input {
        flex: 1;
        padding: 8px;
        border: 1px solid #e5e5e5;
        border-radius: 4px;
    }
    
    button {
        padding: 8px 16px;
        background: #18A0FB;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .todo-item {
        display: flex;
        align-items: center;
        padding: 8px 8px 8px 0;
        border-bottom: 1px solid #e5e5e5;
        gap: 12px;
    }
    
    .todo-checkbox {
        margin-left: 0;
        margin-right: 8px;
    }
    
    .todo-text {
        flex: 1;
    }
    
    .preview-image, #selectionPreview {
        width: 64px;
        height: 64px;
        object-fit: contain;
        background: #f0f0f0;
        border-radius: 4px;
    }
    
    .todo-section {
        margin-bottom: 24px;
    }
    
    .section-title {
        font-size: 14px;
        font-weight: 500;
        color: #333;
        margin: 16px 0 8px 0;
    }
    
    .completed .todo-text {
        text-decoration: line-through;
        color: #888;
    }
    
    .completed .preview-image {
        opacity: 0.6;
    }
</style>

<script>
    function addTodo() {
        const input = document.getElementById('todoInput');
        const text = input.value.trim();
        
        if (text) {
            parent.postMessage({ 
                pluginMessage: { 
                    type: 'add-todo',
                    text: text
                }
            }, '*');
            input.value = '';
        }
    }

    function toggleTodo(todoId, completed) {
        parent.postMessage({ 
            pluginMessage: { 
                type: 'toggle-todo',
                todoId: todoId,
                completed: completed
            }
        }, '*');
    }

    // Listen for messages from the plugin code
    window.onmessage = (event) => {
        const msg = event.data.pluginMessage;
        
        if (msg.type === 'no-selection') {
            alert(msg.message);
        }
        
        if (msg.type === 'todos-updated') {
            updateTodoList(msg.todos);
        }

        if (msg.type === 'selection-preview') {
            const previewImg = document.getElementById('selectionPreview');
            if (msg.preview) {
                previewImg.src = `data:image/png;base64,${msg.preview}`;
                previewImg.classList.remove('hidden');
            } else {
                previewImg.classList.add('hidden');
            }
        }
    }

    function updateTodoList(todos) {
        const todoList = document.getElementById('todoList');
        const activeTodos = todos.filter(todo => !todo.completed);
        const completedTodos = todos.filter(todo => todo.completed);
        
        todoList.innerHTML = `
            <div class="todo-section">
                ${activeTodos.length > 0 ? `
                    <div class="section-title">Active Todos</div>
                    ${renderTodos(activeTodos)}
                ` : ''}
            </div>
            
            <div class="todo-section">
                ${completedTodos.length > 0 ? `
                    <div class="section-title">Completed Todos</div>
                    ${renderTodos(completedTodos)}
                ` : ''}
            </div>
        `;

        // Add event listeners for checkboxes
        todoList.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                const todoId = parseInt(e.target.dataset.todoId);
                toggleTodo(todoId, e.target.checked);
            });
        });
    }

    function renderTodos(todos) {
        return todos.map(todo => `
            <div class="todo-item ${todo.completed ? 'completed' : ''}">
                <input 
                    type="checkbox"
                    class="todo-checkbox"
                    data-todo-id="${todo.id}"
                    ${todo.completed ? 'checked' : ''}
                >
                <span class="todo-text">${todo.text}</span>
                <img 
                    class="preview-image" 
                    src="data:image/png;base64,${todo.preview}" 
                    alt="Preview"
                >
            </div>
        `).join('');
    }
</script>