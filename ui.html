<div id="app">
    <h2>Figminders</h2>
    
    <div class="display-mode">
        <label class="mode-label">Display Mode:</label>
        <div class="mode-toggle">
            <button class="mode-button active" onclick="setDisplayMode('manual')">Manual</button>
            <button class="mode-button" onclick="setDisplayMode('smart')">Smart Grouping</button>
        </div>
    </div>

    <div class="add-todo">
        <img 
            id="selectionPreview" 
            alt="Selection Preview"
            class="hidden"
        >
        <div class="input-group">
            <div class="input-row">
                <input type="text" id="todoInput" placeholder="Enter a todo...">
                <button onclick="addTodo()">Add Todo</button>
            </div>
            <div id="errorMessage" class="error-message">Please enter a todo text</div>
        </div>
    </div>

    <div id="todoList"></div>
</div>

<div class="loading-overlay">
    <div class="loading-spinner">
        <div class="loading-text">Organizing todos...</div>
    </div>
</div>

<style>
    body {
        font-family: Inter, sans-serif;
        padding: 20px;
        background: #fafafa;
    }
    
    #app {
        background: white;
        border-radius: 8px;
        padding: 24px;
    }
    
    .add-todo {
        display: flex;
        gap: 12px;
        margin-bottom: 24px;
        align-items: center;
        padding: 24px;
        border-radius: 8px;
        background: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05),
                    0 4px 12px rgba(0, 0, 0, 0.1);
        border-bottom: none;
    }
    
    .input-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
        flex: 1;
    }
    
    .input-row {
        display: flex;
        gap: 8px;
    }
    
    .hidden {
        display: none;
    }
    
    #selectionPreview {
        width: 150px;
        height: 150px;
    }
    
    input {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #e5e5e5;
        border-radius: 6px;
        font-size: 14px;
    }
    
    input:focus {
        outline: none;
        border-color: #18A0FB;
        box-shadow: 0 0 0 2px rgba(24, 160, 251, 0.1);
    }
    
    button {
        padding: 8px 16px;
        background: #18A0FB;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: background 0.2s ease;
    }
    
    button:hover {
        background: #0F9EF3;
    }
    
    .todo-item {
        display: flex;
        align-items: center;
        padding: 24px 8px 24px 0;
        border-bottom: 1px solid #e5e5e5;
        gap: 0;
        min-height: 75px;
        box-sizing: content-box;
    }
    
    .todo-checkbox {
        margin: 0 0 0 16px;
        padding: 0;
        width: 32px;
        height: 32px;
        flex: none;
        cursor: pointer;
    }
    
    .todo-text {
        flex: 1;
        text-align: left;
        margin-left: 12px;
        margin-right: 12px;
        cursor: text;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        line-height: 1.4;
        white-space: normal;
        min-height: 1.4em;
        padding: 6px 0;
    }
    
    .todo-text-input {
        flex: 1;
        margin-left: 12px;
        margin-right: 12px;
        font-family: Inter, sans-serif;
        font-size: inherit;
        border: none;
        background: transparent;
        padding: 6px 0;
        color: inherit;
        line-height: 1.4;
        min-height: 1.4em;
        resize: none;
    }
    
    .todo-text-input:focus {
        outline: none;
        border-bottom: 2px solid #18A0FB;
    }
    
    .preview-image {
        margin-left: auto;
        max-width: 100px;
        max-height: 75px;
        width: auto;
        height: auto;
        cursor: pointer;
        transition: transform 0.1s ease;
    }
    
    .preview-image:hover {
        transform: scale(1.05);
    }
    
    .preview-image, #selectionPreview {
        object-fit: contain;
        background: #f0f0f0;
        border-radius: 4px;
    }
    
    .todo-section {
        margin-bottom: 32px;
    }
    
    .section-title {
        font-size: 13px;
        font-weight: 500;
        color: #666;
        margin: 32px 0 16px 0;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .completed .todo-text {
        text-decoration: line-through;
        color: #888;
    }
    
    .completed .preview-image {
        opacity: 0.6;
    }
    
    .error-message {
        color: #F24822;
        font-size: 12px;
        margin-top: 4px;
        display: none;
    }
    
    .delete-button {
        color: #999;
        cursor: pointer;
        font-size: 16px;
        padding: 4px 8px;
        border-radius: 4px;
        margin-left: 8px;
    }
    
    .delete-button:hover {
        background: #f0f0f0;
        color: #F24822;
    }
    
    .drag-handle {
        cursor: grab;
        color: #999;
        padding: 4px;
        margin-right: 0;
    }
    
    .drag-handle:hover {
        color: #333;
    }
    
    .todo-item.dragging {
        opacity: 0.5;
        background: #f5f5f5;
    }
    
    .todo-item.drag-over {
        border-top: 2px solid #18A0FB;
    }
    
    h2 {
        font-size: 16px;
        font-weight: 500;
        color: #333;
        margin: 0 0 20px 0;
    }
    
    .display-mode {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
    }
    
    .mode-label {
        font-size: 13px;
        color: #666;
    }
    
    .mode-toggle {
        display: flex;
        gap: 1px;
        background: #E5E5E5;
        padding: 2px;
        border-radius: 6px;
    }
    
    .mode-button {
        background: transparent;
        color: #333;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 13px;
        font-weight: 500;
    }
    
    .mode-button:hover {
        background: rgba(0, 0, 0, 0.05);
    }
    
    .mode-button.active {
        background: white;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
    .todo-group {
        margin-left: 24px;
        border-left: 2px solid #E5E5E5;
        padding-left: 12px;
    }
    
    .todo-group-container {
        margin-bottom: 16px;
        border: 1px solid #E5E5E5;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .todo-group-container > .todo-item {
        background: white;
        border-bottom: 1px solid #E5E5E5;
        margin-bottom: 0;
        padding-left: 8px;
    }
    
    .todo-group {
        background: #FAFAFA;
        padding: 8px 0;
        margin-left: 0;
        border-top: 1px solid #E5E5E5;
    }
    
    .todo-group .todo-item {
        padding-left: 48px;
        border-bottom: 1px solid #EAEAEA;
        background: transparent;
    }
    
    .todo-group .todo-item:last-child {
        border-bottom: none;
    }
    
    /* Standalone todos */
    .todo-section > .todo-item {
        background: white;
        border: 1px solid #E5E5E5;
        margin-bottom: 8px;
        border-radius: 8px;
    }
    
    .preview-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-left: auto;
        gap: 4px;
    }
    
    .layer-name {
        font-size: 11px;
        color: #666;
        max-width: 100px;
        text-align: center;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .loading-overlay {
        display: none;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        align-items: center;
        justify-content: center;
        z-index: 100;
    }
    
    .loading-overlay.active {
        display: flex;
    }
    
    .loading-spinner {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
    }
    
    .loading-spinner::before {
        content: '';
        width: 24px;
        height: 24px;
        border: 2px solid #E5E5E5;
        border-top-color: #18A0FB;
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
    }
    
    .loading-text {
        font-size: 13px;
        color: #333;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>

<script>
    let draggedItem = null;
    let todos = [];  // Keep track of todos in memory
    let currentDisplayMode = 'manual';
    let nodeHierarchies = new Map();
    
    function addTodo() {
        const input = document.getElementById('todoInput');
        const errorMessage = document.getElementById('errorMessage');
        const text = input.value.trim();
        
        if (!text) {
            errorMessage.style.display = 'block';
            return;
        }
        
        errorMessage.style.display = 'none';
        parent.postMessage({ 
            pluginMessage: { 
                type: 'add-todo',
                text: text
            }
        }, '*');
        input.value = '';
    }

    // Also clear error when user starts typing
    document.getElementById('todoInput').addEventListener('input', () => {
        document.getElementById('errorMessage').style.display = 'none';
    });

    function toggleTodo(todoId, completed) {
        parent.postMessage({ 
            pluginMessage: { 
                type: 'toggle-todo',
                todoId: todoId,
                completed: completed
            }
        }, '*');
    }

    // Listen for messages from the plugin code
    window.onmessage = (event) => {
        const msg = event.data.pluginMessage;
        
        if (msg.type === 'no-selection') {
            alert(msg.message);
        }
        
        if (msg.type === 'todos-updated') {
            updateTodoList(msg.todos);
        }

        if (msg.type === 'selection-preview') {
            const previewImg = document.getElementById('selectionPreview');
            if (msg.preview) {
                previewImg.src = `data:image/png;base64,${msg.preview}`;
                previewImg.classList.remove('hidden');
            } else {
                previewImg.classList.add('hidden');
            }
        }

        if (msg.type === 'error') {
            alert(msg.message);
        }

        if (msg.type === 'node-hierarchy') {
            // Store hierarchy information for later use
            if (msg.relationships) {
                nodeHierarchies.set(msg.nodeId, msg.relationships);
            }
        }

        if (msg.type === 'smart-groups-ready') {
            // Hide loading overlay
            document.querySelector('.loading-overlay').classList.remove('active');
            // Update the groups and re-render
            updateSmartGroups(msg.groups);
        }
    }

    function updateTodoList(newTodos) {
        todos = newTodos;
        const todoList = document.getElementById('todoList');
        const activeTodos = todos.filter(todo => !todo.completed);
        const completedTodos = todos.filter(todo => todo.completed);
        
        if (currentDisplayMode === 'manual') {
            todoList.innerHTML = `
                <div class="todo-section">
                    ${renderTodos(activeTodos)}
                </div>
                
                ${completedTodos.length > 0 ? `
                    <div class="todo-section">
                        <div class="section-title">Completed</div>
                        ${renderTodos(completedTodos)}
                    </div>
                ` : ''}
            `;
        } else {
            // Smart Grouping mode
            todoList.innerHTML = `
                <div class="todo-section">
                    ${renderSmartGroups(activeTodos)}
                </div>
                
                ${completedTodos.length > 0 ? `
                    <div class="todo-section">
                        <div class="section-title">Completed</div>
                        ${renderSmartGroups(completedTodos)}
                    </div>
                ` : ''}
            `;
        }

        // Add event listeners for checkboxes and drag-drop
        todoList.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                const todoId = parseInt(e.target.dataset.todoId);
                toggleTodo(todoId, e.target.checked);
            });
        });

        // Add drag and drop listeners
        todoList.querySelectorAll('.todo-item').forEach(item => {
            item.addEventListener('dragstart', handleDragStart);
            item.addEventListener('dragend', handleDragEnd);
            item.addEventListener('dragover', handleDragOver);
            item.addEventListener('drop', handleDrop);
            item.addEventListener('dragenter', handleDragEnter);
            item.addEventListener('dragleave', handleDragLeave);
        });
    }

    function renderTodos(todos) {
        return todos.map(todo => `
            <div class="todo-item ${todo.completed ? 'completed' : ''}"
                 data-todo-id="${todo.id}" 
                 draggable="true">
                <span class="drag-handle">⋮⋮</span>
                <input 
                    type="checkbox"
                    class="todo-checkbox"
                    data-todo-id="${todo.id}"
                    ${todo.completed ? 'checked' : ''}
                >
                <span 
                    class="todo-text" 
                    onclick="startEditing(event, ${todo.id})"
                >${todo.text}</span>
                <div class="preview-container">
                    <img 
                        class="preview-image" 
                        src="data:image/png;base64,${todo.preview}" 
                        alt="Preview"
                        onclick="selectOriginalNode('${todo.nodeId}')"
                    >
                    <span class="layer-name">${todo.nodeName}</span>
                </div>
                <span 
                    class="delete-button" 
                    onclick="deleteTodo(${todo.id})"
                >×</span>
            </div>
        `).join('');
    }

    function deleteTodo(todoId) {
        parent.postMessage({ 
            pluginMessage: { 
                type: 'delete-todo',
                todoId: todoId
            }
        }, '*');
    }

    // Drag and drop handler functions
    function handleDragStart(e) {
        draggedItem = e.target;
        e.target.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
    }

    function handleDragEnd(e) {
        e.target.classList.remove('dragging');
        document.querySelectorAll('.todo-item').forEach(item => {
            item.classList.remove('drag-over');
        });
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    }

    function handleDragEnter(e) {
        e.target.closest('.todo-item')?.classList.add('drag-over');
    }

    function handleDragLeave(e) {
        e.target.closest('.todo-item')?.classList.remove('drag-over');
    }

    function handleDrop(e) {
        e.preventDefault();
        const dropTarget = e.target.closest('.todo-item');
        if (!dropTarget || dropTarget === draggedItem) return;

        // Get the IDs of the dragged and drop target items
        const draggedId = parseInt(draggedItem.dataset.todoId);
        const dropId = parseInt(dropTarget.dataset.todoId);
        
        // Find the indices of both items
        const draggedIndex = todos.findIndex(t => t.id === draggedId);
        const dropIndex = todos.findIndex(t => t.id === dropId);
        
        // Reorder the array
        const [removed] = todos.splice(draggedIndex, 1);
        todos.splice(dropIndex, 0, removed);
        
        // Update the UI and save the new order
        parent.postMessage({ 
            pluginMessage: { 
                type: 'reorder-todos',
                todos: todos
            }
        }, '*');
        
        updateTodoList(todos);
    }

    function startEditing(event, todoId) {
        const textSpan = event.target;
        const currentText = textSpan.textContent;
        
        // Create textarea element instead of input
        const textarea = document.createElement('textarea');
        textarea.value = currentText;
        textarea.className = 'todo-text-input';
        textarea.rows = 2;
        
        // Replace span with textarea
        textSpan.parentNode.replaceChild(textarea, textSpan);
        textarea.focus();
        
        // Handle saving on enter or blur
        textarea.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // Prevent new line on Enter
                saveEdit(textarea, todoId);
            }
            if (e.key === 'Escape') {
                cancelEdit(textarea, currentText);
            }
        });
        
        textarea.addEventListener('blur', () => {
            saveEdit(textarea, todoId);
        });
        
        // Prevent dragging while editing
        const todoItem = textarea.closest('.todo-item');
        todoItem.setAttribute('draggable', 'false');
    }

    function saveEdit(input, todoId) {
        const newText = input.value.trim();
        if (newText) {
            parent.postMessage({ 
                pluginMessage: { 
                    type: 'update-todo-text',
                    todoId: todoId,
                    text: newText
                }
            }, '*');
        }
        
        // Re-enable dragging
        const todoItem = input.closest('.todo-item');
        todoItem.setAttribute('draggable', 'true');
    }

    function cancelEdit(input, originalText) {
        const span = document.createElement('span');
        span.className = 'todo-text';
        span.textContent = originalText;
        input.parentNode.replaceChild(span, input);
        
        // Re-enable dragging
        const todoItem = span.closest('.todo-item');
        todoItem.setAttribute('draggable', 'true');
    }

    function selectOriginalNode(nodeId) {
        parent.postMessage({ 
            pluginMessage: { 
                type: 'select-node',
                nodeId: nodeId
            }
        }, '*');
    }

    function setDisplayMode(mode) {
        currentDisplayMode = mode;
        
        // Update button styles
        document.querySelectorAll('.mode-button').forEach(btn => {
            btn.classList.toggle('active', btn.innerText.toLowerCase().includes(mode));
        });
        
        if (mode === 'smart') {
            // Show loading overlay
            document.querySelector('.loading-overlay').classList.add('active');
            
            // Request smart groups organization
            parent.postMessage({ 
                pluginMessage: { 
                    type: 'organize-smart-groups',
                    todos: todos
                }
            }, '*');
        } else {
            updateTodoList(todos);
        }
    }
    
    function getNodeHierarchy(nodeId) {
        parent.postMessage({ 
            pluginMessage: { 
                type: 'get-node-hierarchy',
                nodeId: nodeId
            }
        }, '*');
    }

    function renderSmartGroups(todos) {
        // Request hierarchy information and organization
        parent.postMessage({ 
            pluginMessage: { 
                type: 'organize-smart-groups',
                todos: todos
            }
        }, '*');
        
        // Return empty string - actual rendering will happen when we get the response
        return '';
    }

    function updateSmartGroups(groups) {
        const todoList = document.getElementById('todoList');
        if (!todoList) return;

        const activeTodos = todos.filter(todo => !todo.completed);
        const completedTodos = todos.filter(todo => todo.completed);

        if (currentDisplayMode === 'smart') {
            todoList.innerHTML = `
                <div class="todo-section">
                    ${renderGroupedTodos(groups, activeTodos)}
                </div>
                
                ${completedTodos.length > 0 ? `
                    <div class="todo-section">
                        <div class="section-title">Completed</div>
                        ${renderGroupedTodos(groups, completedTodos)}
                    </div>
                ` : ''}
            `;

            // Re-add event listeners
            addTodoEventListeners();
        }
    }

    function renderGroupedTodos(groups, filteredTodos) {
        console.log('\n📋 === SMART GROUP RENDERING START ===');
        console.log(`Total todos to process: ${filteredTodos.length}`);
        console.log('Groups:', groups);
        
        const processedIds = new Set();
        
        // First render grouped todos
        console.log('\n🔄 Processing Groups:');
        const groupedContent = groups
            .filter(([nodeId, children]) => {
                // Find parent todo by nodeId (e.g., "2:6")
                const parent = filteredTodos.find(t => t.nodeId === nodeId);
                if (!parent) {
                    console.log(`❌ Could not find todo with nodeId: "${nodeId}"`);
                    return false;
                }
                console.log(`✅ Found group parent: "${parent.text}" (Node: ${parent.nodeName})`);
                return true;
            })
            .map(([nodeId, children]) => {
                const parentTodo = filteredTodos.find(t => t.nodeId === nodeId);
                processedIds.add(parentTodo.id);
                
                // Filter and find the actual todo objects for children
                const validChildren = children
                    .filter(child => {
                        const found = filteredTodos.find(t => t.nodeId === child.nodeId);
                        if (found) {
                            processedIds.add(found.id);
                            return true;
                        }
                        return false;
                    })
                    .map(child => filteredTodos.find(t => t.nodeId === child.nodeId));

                console.log(`📦 Processing group "${parentTodo.text}" with ${validChildren.length} children`);
                
                if (validChildren.length === 0) {
                    console.log(`  └─ No children, rendering as standalone`);
                    return renderTodos([parentTodo]);
                }
                
                console.log(`  └─ Rendering as group with ${validChildren.length} children`);
                return `
                    <div class="todo-group-container">
                        ${renderTodos([parentTodo])}
                        <div class="todo-group">
                            ${renderTodos(validChildren)}
                        </div>
                    </div>
                `;
            }).join('');

        // Handle remaining todos
        const remainingTodos = filteredTodos.filter(todo => !processedIds.has(todo.id));
        console.log('\n📌 Remaining Ungrouped Todos:');
        remainingTodos.forEach(todo => {
            console.log(`   • "${todo.text}" (Node: "${todo.nodeName}")`);
        });
        
        const remainingContent = remainingTodos.length > 0 ? renderTodos(remainingTodos) : '';
        
        return groupedContent + remainingContent;
    }

    function addTodoEventListeners() {
        const todoList = document.getElementById('todoList');
        
        todoList.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                const todoId = parseInt(e.target.dataset.todoId);
                toggleTodo(todoId, e.target.checked);
            });
        });

        if (currentDisplayMode === 'manual') {
            todoList.querySelectorAll('.todo-item').forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragenter', handleDragEnter);
                item.addEventListener('dragleave', handleDragLeave);
            });
        }
    }
</script>